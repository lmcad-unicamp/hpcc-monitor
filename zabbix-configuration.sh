sudo sed -i "s/# Hostname=/Hostname=$(curl http://169.254.169.254/latest/meta-data/instance-id)/g" $3
sudo sed -i "s/Server=127.0.0.1/Server=$1/g" $3
sudo sed -i "s/ServerActive=127.0.0.1/ServerActive=$1/g" $3
sudo sed -i "/Hostname=Zabbix server/d" $3
sudo sed -i "s/# Timeout=3/Timeout=30/g" $3
sudo sed -i "s/# HostMetadata=/HostMetadata=$(curl http://169.254.169.254/latest/meta-data/instance-type)-$2/g" $3
sudo sed -i "s/# EnableRemoteCommands=0/EnableRemoteCommands=1/g" $3
sudo sed -i "s@# UserParameter=@UserParameter=gpu.missingdrivers,if [ ! -z \"\$(lspci | grep 'NVIDIA')\" ]; then if [ ! -z \"\$(nvidia-smi 2> /dev/null)\" ]; then echo \"11\"; else echo \"10\"; fi; else  echo \"00\"; fi\nUserParameter=gpu.utilization,echo \"scale=3 ; \$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits | awk '{s+=\$1} END {printf \"%d\", s}') / \$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits | awk 'END { print NR }')\" | bc\nUserParameter=gpu.memory.utilization,echo \"scale=3 ; \$(nvidia-smi --query-gpu=utilization.memory --format=csv,noheader,nounits | awk '{s+=\$1} END {printf \"%d\", s}') / \$(nvidia-smi --query-gpu=utilization.memory --format=csv,noheader,nounits | awk 'END { print NR }')\" | bc\nUserParameter=gpu.memory.available,echo \"scale=3 ; \$(nvidia-smi --query-gpu=memory.free --format=csv,noheader,nounits | awk '{s+=\$1} END {printf \"%d\", s}') * 100 / \$(nvidia-smi --query-gpu=memory.total --format=csv,noheader,nounits | awk '{s+=\$1} END {printf \"%d\", s}')\" | bc\nUserParameter=gpu.memory.used,echo \"scale=3 ; \$(nvidia-smi --query-gpu=memory.used --format=csv,noheader,nounits | awk '{s+=\$1} END {printf \"%d\", s}') * 100 / \$(nvidia-smi --query-gpu=memory.total --format=csv,noheader,nounits | awk '{s+=\$1} END {printf \"%d\", s}')\" | bc\nUserParameter=gpu.idle,echo \"scale=3 ; \$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits | awk '{s+=100-\$1} END {printf \"%d\", s}') / \$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits | awk 'END { print NR }')\" | bc\nUserParameter=vfs.fs.infos,df --output=source,fstype,size,avail,pcent,target | gawk 'BEGIN { ORS = \"\"; print \" [ \"}/Filesystem/ {next} /Sis/ {next}{ printf \"%s{\\\\\"dev\\\\\": \\\\\"%s\\\\\", \\\\\"fstype\\\\\": \\\\\"%s\\\\\", \\\\\"size\\\\\": \\\\\"%s\\\\\", \\\\\"pfree\\\\\": \\\\\"%s\\\\\", \\\\\"pused\\\\\": \\\\\"%s\\\\\", \\\\\"fsname\\\\\": \\\\\"%s\\\\\"}\", separator, \$1, \$2, \$3, \$4*100/\$3, \$5, \$6, separator = \", \"} END { print \" ] \" }'\nUserParameter=net.if.infos,ifconfig | grep \"^[a-z]\" | cut -d\":\" -f1 | gawk 'ORS=\"\"; BEGIN {print \"[\"} {printf \"%s{\\\\\"interface\\\\\": \\\\\"%s\\\\\"}\", separator, \$1, separator = \", \"} END {print \"]\"}'\nUserParameter=ssh.connections,who@g" $3
